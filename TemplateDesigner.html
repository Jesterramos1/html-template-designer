<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Template Designer</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            padding: 20px;
        }

        .canvas-container {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background: #f8f9fa;
            position: relative;
        }

        .toolbar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .toolbar-section {
            margin-bottom: 15px;
        }

        .toolbar-section:last-child {
            margin-bottom: 0;
        }

        .toolbar-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-wrapper {
            position: relative;
            background-color: #fff;
            margin: 0 auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        .grid-bg {
            background-image: linear-gradient(to right, #e0e0e0 1px, transparent 1px), linear-gradient(to bottom, #e0e0e0 1px, transparent 1px);
            background-size: 10px 10px;
        }

        .field {
            position: absolute;
            font-size: 10px;
            font-weight: normal;
            color: #000;
            border: 1px dashed #007bff;
            padding: 0px;
            background: rgba(255,255,255,0.9);
            cursor: move;
            user-select: none;
            min-width: 60px;
            min-height: 10px;
            transition: all 0.2s ease;
            box-sizing: border-box;
            z-index: 10 !important;
        }

        .field:hover {
            border-color: #0056b3;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }

        .field.selected {
            border-color: #ff6b6b;
            border-style: solid;
            border-width: 2px;
            box-shadow: 0 0 0 2px rgba(255,107,107,0.2);
        }

        .field.dragging {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .hide-labels .label {
            display: none !important;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group-sm {
            flex: 1;
        }

        .color-picker {
            width: 40px;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .alignment-buttons {
            display: flex;
            gap: 4px;
        }

        .alignment-buttons .btn {
            padding: 6px 10px;
            margin: 0;
            font-size: 12px;
        }

        .properties-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .properties-panel h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .no-selection {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .field-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: #f8f9fa;
        }

        .field-item {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
            background: white;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .field-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .field-item.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-controls .btn {
            margin: 0;
            padding: 4px 8px;
            font-size: 12px;
        }

        .status-bar {
            background: #2c3e50;
            color: white;
            padding: 8px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .guideline {
            position: absolute;
            background: #ff6b6b;
            pointer-events: none;
            z-index: 999;
        }

        .guideline-h {
            height: 1px;
            left: 0;
            right: 0;
        }

        .guideline-v {
            width: 1px;
            top: 0;
            bottom: 0;
        }

        .shape {
            min-width: 30px;
            min-height: 30px;
            cursor: move;
            background-color: transparent !important;
            z-index: 0 !important;
        }

        .line {
            min-width: 30px;
            min-height: 1px;
            background-color: #000;
            transform-origin: 0 0;
            cursor: move;
            z-index: 2 !important;
        }

        .line-endpoint {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #007bff;
            cursor: move;
            z-index: 10;
        }

        .line-endpoint.start-point {
            left: -5px;
            top: -5px;
        }

        .line-endpoint.end-point {
            right: -5px;
            bottom: -5px;
        }

        .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #007bff;
            border: 1px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
        }

        .resize-handle.top-left {
            top: -4px;
            left: -4px;
            cursor: nwse-resize;
        }

        .resize-handle.top-right {
            top: -4px;
            right: -4px;
            cursor: nesw-resize;
        }

        .resize-handle.bottom-left {
            bottom: -4px;
            left: -4px;
            cursor: nesw-resize;
        }

        .resize-handle.bottom-right {
            bottom: -4px;
            right: -4px;
            cursor: nwse-resize;
        }

        .rotate-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #28a745;
            border: 2px solid white;
            border-radius: 50%;
            top: -20px;
            left: 50%;
            margin-left: -8px;
            cursor: pointer;
            display: none;
        }

        .line.selected .rotate-handle {
            display: block;
        }

        .underline {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Template Designer</h1>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="toolbar">
                <div class="toolbar-section">
                    <h3>Actions</h3>
                    <button class="btn btn-primary" id="addFieldBtn">Add Field</button>
                    <button class="btn btn-primary" id="addLabelBtn">Add Label</button>
                    <button class="btn btn-primary" id="addRectangleBtn">Add Rectangle</button>
                    <button class="btn btn-primary" id="addLineBtn">Add Line</button>
                    <button class="btn btn-secondary" id="toggleDragBtn">Enable Drag</button>
                    <button class="btn btn-secondary" id="toggleLabelsBtn">Hide Labels</button>
                    <button class="btn btn-secondary" id="toggleGridBtn">Show Grid</button>
                </div>

                <div class="toolbar-section">
                    <h3>Canvas Size</h3>
                    <div class="form-group">
                        <label>Preset Sizes</label>
                        <select class="form-control" id="sizePreset">
                            <option value="custom">Custom</option>
                            <option value="8.5x11" selected>Letter (8.5" � 11")</option>
                            <option value="11x8.5">Letter Landscape (11" � 8.5")</option>
                            <option value="8.5x14">Legal (8.5" � 14")</option>
                            <option value="11x17">Tabloid (11" � 17")</option>
                            <option value="8.27x11.69">A4 (8.27" � 11.69")</option>
                            <option value="11.69x8.27">A4 Landscape</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <div class="input-group-sm">
                            <label>Width (in)</label>
                            <input type="number" class="form-control" id="canvasWidth" value="8.5" step="0.1">
                        </div>
                        <div class="input-group-sm">
                            <label>Height (in)</label>
                            <input type="number" class="form-control" id="canvasHeight" value="11" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="toolbar-section">
                    <h3>Export</h3>
                    <button class="btn btn-success" id="downloadHtmlBtn">Download HTML</button>
                    <button class="btn btn-secondary" id="copyCssBtn">Copy CSS</button>
                    <button class="btn btn-success" id="downloadPdfBtn">Download PDF</button>
                </div>
                <div class="toolbar-section">
                    <h3>Import Template</h3>
                    <input type="file" id="uploadTemplateInput" accept=".html" class="form-control">
                </div>
            </div>

            <div class="properties-panel">
                <h3>Properties</h3>
                <div id="propertiesContent">
                    <div class="no-selection">Select a field to edit its properties</div>
                </div>
            </div>

            <div class="toolbar-section">
                <h3>Field List</h3>
                <div class="field-list" id="fieldList">
                    <!-- Field items will be populated here -->
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="form-wrapper" id="formWrapper">
            </div>

            <div class="zoom-controls">
                <button class="btn btn-secondary" id="zoomOutBtn">-</button>
                <span id="zoomLevel">100%</span>
                <button class="btn btn-secondary" id="zoomInBtn">+</button>
                <button class="btn btn-secondary" id="fitToPageBtn">Fit</button>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div id="statusText">Ready</div>
        <div id="positionInfo">Position: 0, 0</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            class TemplateDesigner {
                constructor() {
                    this.dragEnabled = false;
                    this.snapToGrid = true;
                    this.gridSize = 10;
                    this.selectedField = null;
                    this.fieldCounter = 0;
                    this.zoomLevel = 1;
                    this.history = [];
                    this.historyIndex = -1;

                    this.init();
                }

                init() {
                    this.bindEvents();
                    this.setupDragAndDrop();
                    this.updateFieldList();
                    this.updateCanvasSize();
                    this.saveState();
                }

                bindEvents() {
                    // Toolbar buttons
                    document.getElementById('toggleDragBtn').addEventListener('click', () => this.toggleDragMode());
                    document.getElementById('toggleGridBtn').addEventListener('click', () => this.toggleGrid());
                    document.getElementById('addFieldBtn').addEventListener('click', () => this.addField());
                    document.getElementById('addLabelBtn').addEventListener('click', () => this.addLabel());
                    document.getElementById('toggleLabelsBtn').addEventListener('click', () => this.toggleLabels());
                    document.getElementById('addRectangleBtn').addEventListener('click', () => this.addRectangle());
                    document.getElementById('addLineBtn').addEventListener('click', () => this.addLine());

                    // Canvas size controls
                    document.getElementById('sizePreset').addEventListener('change', (e) => this.setSizePreset(e.target.value));
                    document.getElementById('canvasWidth').addEventListener('input', () => this.updateCanvasSize());
                    document.getElementById('canvasHeight').addEventListener('input', () => this.updateCanvasSize());

                    // Export buttons
                    document.getElementById('downloadHtmlBtn').addEventListener('click', () => this.downloadHtml());
                    document.getElementById('copyCssBtn').addEventListener('click', () => this.copyCss());
                    document.getElementById('downloadPdfBtn').addEventListener('click', () => this.downloadPdf());

                    // Import template
                    document.getElementById('uploadTemplateInput').addEventListener('change', (e) => this.loadHtmlTemplate(e));

                    // Zoom controls
                    document.getElementById('zoomInBtn').addEventListener('click', () => this.zoom(1.2));
                    document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoom(0.8));
                    document.getElementById('fitToPageBtn').addEventListener('click', () => this.fitToPage());

                    // Field selection
                    document.addEventListener('click', (e) => this.handleFieldSelection(e));

                    // Keyboard shortcuts
                    document.addEventListener('keydown', (e) => this.handleKeyboard(e));

                    // Mouse tracking
                    document.getElementById('formWrapper').addEventListener('mousemove', (e) => this.updateMousePosition(e));
                }

                toggleDragMode() {
                    this.dragEnabled = !this.dragEnabled;
                    const btn = document.getElementById('toggleDragBtn');
                    btn.textContent = this.dragEnabled ? 'Disable Drag' : 'Enable Drag';
                    btn.className = this.dragEnabled ? 'btn btn-danger' : 'btn btn-secondary';
                    this.updateStatus(this.dragEnabled ? 'Drag mode enabled' : 'Drag mode disabled');
                }

                toggleGrid() {
                    const formWrapper = document.getElementById('formWrapper');
                    formWrapper.classList.toggle('grid-bg');
                    const btn = document.getElementById('toggleGridBtn');
                    btn.textContent = formWrapper.classList.contains('grid-bg') ? 'Hide Grid' : 'Show Grid';
                }

                setSizePreset(preset) {
                    if (preset === 'custom') return;

                    const [width, height] = preset.split('x').map(Number);
                    document.getElementById('canvasWidth').value = width;
                    document.getElementById('canvasHeight').value = height;
                    this.updateCanvasSize();
                }

                toggleLabels() {
                    const wrapper = document.getElementById('formWrapper');
                    const btn = document.getElementById('toggleLabelsBtn');
                    const isHiding = wrapper.classList.toggle('hide-labels');

                    btn.textContent = isHiding ? 'Show Labels' : 'Hide Labels';
                    this.updateStatus(isHiding ? 'Labels hidden' : 'Labels visible');
                }

                updateCanvasSize() {
                    const width = parseFloat(document.getElementById('canvasWidth').value);
                    const height = parseFloat(document.getElementById('canvasHeight').value);
                    const formWrapper = document.getElementById('formWrapper');

                    formWrapper.style.width = `${width}in`;
                    formWrapper.style.height = `${height}in`;

                    this.updateStatus(`Canvas size: ${width}" � ${height}"`);
                }

                addRectangle() {
                    const nextNum = this.getNextFieldNumber('rectangle');
                    this.fieldCounter = Math.max(this.fieldCounter, nextNum);

                    const rect = document.createElement('div');
                    rect.className = 'field label draggable shape rectangle';
                    rect.classList.add(`field-rectangle-${this.fieldCounter}`);
                    rect.style.top = '50px';
                    rect.style.left = '50px';
                    rect.style.width = '100px';
                    rect.style.height = '60px';
                    rect.style.backgroundColor = 'transparent';
                    rect.style.border = '1px solid #000';
                    rect.style.borderRadius = '0px';

                    // Add resize handles
                    this.addResizeHandles(rect);

                    document.getElementById('formWrapper').appendChild(rect);
                    this.setupShapeEvents(rect);
                    this.updateFieldList();
                    this.selectField(rect);
                    this.saveState();
                }

                addLine() {
                    const nextNum = this.getNextFieldNumber('line');
                    this.fieldCounter = Math.max(this.fieldCounter, nextNum);

                    const line = document.createElement('div');
                    line.className = 'field label draggable line';
                    line.classList.add(`field-line-${this.fieldCounter}`);
                    line.style.top = '50px';
                    line.style.left = '50px';
                    line.style.width = '100px';
                    line.style.height = '2px';
                    line.style.backgroundColor = '#000';
                    line.style.transformOrigin = '0 0';

                    // Create endpoints
                    const startPoint = document.createElement('div');
                    startPoint.className = 'line-endpoint start-point';
                    startPoint.style.position = 'absolute';
                    startPoint.style.width = '10px';
                    startPoint.style.height = '10px';
                    startPoint.style.borderRadius = '50%';
                    startPoint.style.backgroundColor = '#007bff';
                    startPoint.style.left = '-5px';
                    startPoint.style.top = '-5px';
                    startPoint.style.cursor = 'move';
                    startPoint.style.zIndex = '10';

                    const endPoint = document.createElement('div');
                    endPoint.className = 'line-endpoint end-point';
                    endPoint.style.position = 'absolute';
                    endPoint.style.width = '10px';
                    endPoint.style.height = '10px';
                    endPoint.style.borderRadius = '50%';
                    endPoint.style.backgroundColor = '#007bff';
                    endPoint.style.right = '-5px';
                    endPoint.style.bottom = '-5px';
                    endPoint.style.cursor = 'move';
                    endPoint.style.zIndex = '10';

                    // Create rotate handle
                    const rotateHandle = document.createElement('div');
                    rotateHandle.className = 'rotate-handle';
                    rotateHandle.title = 'Rotate 90�';

                    line.appendChild(startPoint);
                    line.appendChild(endPoint);
                    line.appendChild(rotateHandle);

                    startPoint.style.display = 'none';
                    endPoint.style.display = 'none';
                    rotateHandle.style.display = 'none';

                    document.getElementById('formWrapper').appendChild(line);
                    this.setupLineEvents(line);
                    this.updateFieldList();
                    this.selectField(line);
                    this.saveState();
                }

                addResizeHandles(element) {
                    const positions = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];

                    positions.forEach(pos => {
                        const handle = document.createElement('div');
                        handle.className = `resize-handle ${pos}`;
                        handle.style.display = 'none';
                        element.appendChild(handle);
                    });

                    this.setupResizeEvents(element);
                }

                setupResizeEvents(element) {
                    const handles = element.querySelectorAll('.resize-handle');

                    handles.forEach(handle => {
                        handle.addEventListener('mousedown', (e) => {
                            e.stopPropagation();
                            this.startResizing(element, e, handle.classList.contains('top-left'),
                                handle.classList.contains('top-right'),
                                handle.classList.contains('bottom-left'),
                                handle.classList.contains('bottom-right'));
                        });
                    });
                }

                startResizing(element, e, isTopLeft, isTopRight, isBottomLeft, isBottomRight) {
                    e.preventDefault();

                    const startX = e.clientX;
                    const startY = e.clientY;
                    const startWidth = parseInt(element.style.width);
                    const startHeight = parseInt(element.style.height);
                    const startLeft = parseInt(element.style.left);
                    const startTop = parseInt(element.style.top);

                    const onMouseMove = (moveEvent) => {
                        const dx = moveEvent.clientX - startX;
                        const dy = moveEvent.clientY - startY;

                        if (isTopLeft) {
                            element.style.width = (startWidth - dx) + 'px';
                            element.style.height = (startHeight - dy) + 'px';
                            element.style.left = (startLeft + dx) + 'px';
                            element.style.top = (startTop + dy) + 'px';
                        } else if (isTopRight) {
                            element.style.width = (startWidth + dx) + 'px';
                            element.style.height = (startHeight - dy) + 'px';
                            element.style.top = (startTop + dy) + 'px';
                        } else if (isBottomLeft) {
                            element.style.width = (startWidth - dx) + 'px';
                            element.style.height = (startHeight + dy) + 'px';
                            element.style.left = (startLeft + dx) + 'px';
                        } else { // bottom-right
                            element.style.width = (startWidth + dx) + 'px';
                            element.style.height = (startHeight + dy) + 'px';
                        }
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        this.saveState();
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                }

                setupShapeEvents(shape) {
                    this.setupFieldEvents(shape);

                    shape.addEventListener('dblclick', () => {
                        if (!this.dragEnabled) {
                            this.selectField(shape);
                        }
                    });
                }

                setupLineEvents(line) {
                    const startPoint = line.querySelector('.start-point');
                    const endPoint = line.querySelector('.end-point');
                    const rotateHandle = line.querySelector('.rotate-handle');

                    // Line movement
                    line.addEventListener('mousedown', (e) => {
                        if (!this.dragEnabled || e.target !== line) return;
                        e.preventDefault();

                        const startX = e.clientX;
                        const startY = e.clientY;
                        const startLeft = parseInt(line.style.left);
                        const startTop = parseInt(line.style.top);

                        const onMouseMove = (moveEvent) => {
                            const dx = moveEvent.clientX - startX;
                            const dy = moveEvent.clientY - startY;

                            line.style.left = (startLeft + dx) + 'px';
                            line.style.top = (startTop + dy) + 'px';
                        };

                        const onMouseUp = () => {
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                            this.saveState();
                        };

                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });

                    // Start point movement
                    startPoint.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        e.preventDefault();

                        const startX = e.clientX;
                        const startY = e.clientY;
                        const lineRect = line.getBoundingClientRect();
                        const parentRect = document.getElementById('formWrapper').getBoundingClientRect();

                        const onMouseMove = (moveEvent) => {
                            const dx = moveEvent.clientX - startX;
                            const dy = moveEvent.clientY - startY;

                            // Calculate new dimensions
                            const newWidth = Math.max(1, lineRect.width + dx);
                            const newHeight = Math.max(1, lineRect.height + dy);

                            // Update line dimensions
                            line.style.width = newWidth + 'px';
                            line.style.height = newHeight + 'px';
                        };

                        const onMouseUp = () => {
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                            this.saveState();
                        };

                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });

                    // End point movement
                    endPoint.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        e.preventDefault();

                        const startX = e.clientX;
                        const startY = e.clientY;
                        const lineRect = line.getBoundingClientRect();
                        const parentRect = document.getElementById('formWrapper').getBoundingClientRect();

                        const onMouseMove = (moveEvent) => {
                            const dx = moveEvent.clientX - startX;
                            const dy = moveEvent.clientY - startY;

                            // Calculate new dimensions
                            const newWidth = Math.max(1, lineRect.width + dx);
                            const newHeight = Math.max(1, lineRect.height + dy);

                            // Update line dimensions
                            line.style.width = newWidth + 'px';
                            line.style.height = newHeight + 'px';
                        };

                        const onMouseUp = () => {
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                            this.saveState();
                        };

                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });

                    // Rotate handle
                    rotateHandle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const currentTransform = line.style.transform || 'rotate(0deg)';
                        const currentAngle = parseInt(currentTransform.match(/rotate\((\d+)deg\)/)[1]) || 0;
                        const newAngle = (currentAngle + 90) % 360;
                        line.style.transform = `rotate(${newAngle}deg)`;
                        this.saveState();
                    });

                    line.addEventListener('dblclick', () => {
                        if (!this.dragEnabled) {
                            this.selectField(line);
                        }
                    });
                }

                addField() {
                    const nextNum = this.getNextFieldNumber('custom');
                    this.fieldCounter = Math.max(this.fieldCounter, nextNum);

                    const field = document.createElement('div');
                    field.className = 'field draggable';
                    field.classList.add(`field-custom-${this.fieldCounter}`);
                    field.textContent = `Field ${this.fieldCounter}`;
                    field.style.top = '50px';
                    field.style.left = '50px';
                    field.contentEditable = true;

                    document.getElementById('formWrapper').appendChild(field);
                    this.setupFieldEvents(field);
                    this.updateFieldList();
                    this.selectField(field);
                    this.saveState();
                }

                addLabel() {
                    const nextNum = this.getNextFieldNumber('label');
                    this.fieldCounter = Math.max(this.fieldCounter, nextNum);

                    const label = document.createElement('div');
                    label.className = 'field draggable label';
                    label.classList.add(`field-label-${this.fieldCounter}`);
                    label.textContent = `Label ${this.fieldCounter}`;
                    label.style.top = '50px';
                    label.style.left = '50px';
                    label.contentEditable = true;
                    label.style.padding = '0px 1px';

                    document.getElementById('formWrapper').appendChild(label);
                    this.setupFieldEvents(label);
                    this.updateFieldList();
                    this.selectField(label);
                    this.saveState();
                }

                setupDragAndDrop() {
                    let offsetX, offsetY, dragged;

                    document.querySelectorAll('.draggable').forEach(el => {
                        this.setupFieldEvents(el);
                    });
                }

                setupFieldEvents(field) {
                    field.addEventListener('mousedown', (e) => {
                        if (!this.dragEnabled) return;
                        e.preventDefault();

                        this.dragged = field;
                        field.classList.add('dragging');

                        const rect = field.getBoundingClientRect();
                        const parentRect = document.getElementById('formWrapper').getBoundingClientRect();

                        this.offsetX = e.clientX - rect.left;
                        this.offsetY = e.clientY - rect.top;

                        document.addEventListener('mousemove', this.onMouseMove.bind(this));
                        document.addEventListener('mouseup', this.onMouseUp.bind(this));
                    });

                    field.addEventListener('dblclick', () => {
                        if (!this.dragEnabled) {
                            field.contentEditable = true;
                            field.focus();
                            this.selectTextContent(field);
                        }
                    });

                    field.addEventListener('blur', () => {
                        field.contentEditable = false;
                        this.updateFieldList();
                        this.saveState();
                    });

                    field.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            field.blur();
                        }
                    });
                }

                onMouseMove(e) {
                    if (!this.dragged) return;

                    const parentRect = document.getElementById('formWrapper').getBoundingClientRect();
                    let x = e.clientX - parentRect.left - this.offsetX;
                    let y = e.clientY - parentRect.top - this.offsetY;

                    if (this.snapToGrid) {
                        x = Math.round(x / this.gridSize) * this.gridSize;
                        y = Math.round(y / this.gridSize) * this.gridSize;
                    }

                    // Boundaries
                    x = Math.max(0, Math.min(x, parentRect.width - this.dragged.offsetWidth));
                    y = Math.max(0, Math.min(y, parentRect.height - this.dragged.offsetHeight));

                    this.dragged.style.left = `${x}px`;
                    this.dragged.style.top = `${y}px`;

                    this.updatePositionInfo(x, y);
                    this.showGuidelines(x, y);
                }

                onMouseUp() {
                    if (this.dragged) {
                        this.dragged.classList.remove('dragging');
                        this.hideGuidelines();
                        this.saveState();
                    }

                    document.removeEventListener('mousemove', this.onMouseMove.bind(this));
                    document.removeEventListener('mouseup', this.onMouseUp.bind(this));
                    this.dragged = null;
                }

                showGuidelines(x, y) {
                    this.hideGuidelines();

                    const formWrapper = document.getElementById('formWrapper');
                    const fields = formWrapper.querySelectorAll('.field:not(.dragging)');

                    fields.forEach(field => {
                        const fieldRect = field.getBoundingClientRect();
                        const parentRect = formWrapper.getBoundingClientRect();

                        const fieldX = fieldRect.left - parentRect.left;
                        const fieldY = fieldRect.top - parentRect.top;

                        const tolerance = 5;

                        if (Math.abs(x - fieldX) < tolerance) {
                            this.createGuideline('vertical', fieldX);
                        }

                        if (Math.abs(y - fieldY) < tolerance) {
                            this.createGuideline('horizontal', fieldY);
                        }
                    });
                }

                createGuideline(type, position) {
                    const guideline = document.createElement('div');
                    guideline.className = `guideline guideline-${type.charAt(0)}`;
                    guideline.style[type === 'vertical' ? 'left' : 'top'] = `${position}px`;

                    document.getElementById('formWrapper').appendChild(guideline);
                }

                hideGuidelines() {
                    document.querySelectorAll('.guideline').forEach(el => el.remove());
                }

                handleFieldSelection(e) {
                    if (e.target.classList.contains('field')) {
                        this.selectField(e.target);
                    } else if (!e.target.closest('.properties-panel')) {
                        this.selectField(null);
                    }
                }

                selectField(field) {
                    document.querySelectorAll('.field.selected').forEach(el => el.classList.remove('selected'));
                    document.querySelectorAll('.resize-handle').forEach(h => h.style.display = 'none');
                    document.querySelectorAll('.line-endpoint').forEach(p => p.style.display = 'none');
                    document.querySelectorAll('.rotate-handle').forEach(r => r.style.display = 'none');

                    this.selectedField = field;

                    if (field) {
                        field.classList.add('selected');
                        this.showProperties(field);
                    } else {
                        this.hideProperties();
                    }

                    if (field && field.classList.contains('shape')) {
                        field.querySelectorAll('.resize-handle').forEach(h => h.style.display = 'block');
                    }

                    if (field && field.classList.contains('line')) {
                        field.querySelectorAll('.line-endpoint').forEach(p => p.style.display = 'block');
                        field.querySelector('.rotate-handle').style.display = 'block';
                    }

                    this.updateFieldList();
                }

                showProperties(field) {
                    const content = document.getElementById('propertiesContent');
                    const style = getComputedStyle(field);

                    let textProps = '';
                    let shapeProps = '';
                    let lineProps = '';

                    if (field.classList.contains('label') || field.classList.contains('field') && !field.classList.contains('shape') && !field.classList.contains('line')) {
                        textProps = `
                            <div class="form-group">
                                <label>Text</label>
                                <input type="text" class="form-control" id="propText" value="${field.textContent}">
                            </div>
                            <div class="form-group">
                                <label>Text Alignment</label>
                                <div class="alignment-buttons">
                                    <button class="btn btn-secondary ${style.textAlign === 'left' ? 'active' : ''}" id="alignLeft">Left</button>
                                    <button class="btn btn-secondary ${style.textAlign === 'center' ? 'active' : ''}" id="alignCenter">Center</button>
                                    <button class="btn btn-secondary ${style.textAlign === 'right' ? 'active' : ''}" id="alignRight">Right</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Font Size (px)</label>
                                <input type="number" class="form-control" id="propFontSize" value="${parseInt(style.fontSize)}" min="6" max="72">
                            </div>
                            <div class="form-group">
                                <label>Font Weight</label>
                                <select class="form-control" id="propFontWeight">
                                    <option value="normal" ${style.fontWeight === 'normal' ? 'selected' : ''}>Normal</option>
                                    <option value="bold" ${style.fontWeight === 'bold' ? 'selected' : ''}>Bold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Text Decoration</label>
                                <select class="form-control" id="propTextDecoration">
                                    <option value="none" ${style.textDecoration === 'none' ? 'selected' : ''}>None</option>
                                    <option value="underline" ${style.textDecoration.includes('underline') ? 'selected' : ''}>Underline</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Text Color</label>
                                <input type="color" class="color-picker" id="propTextColor" value="${this.rgbToHex(style.color)}">
                            </div>
                        `;
                    }

                    if (field.classList.contains('shape')) {
                        shapeProps = `
                            <div class="form-group">
                                <label>Border Width (px)</label>
                                <input type="number" class="form-control" id="propBorderWidth" value="${parseInt(style.borderWidth)}" min="0" max="10">
                            </div>
                            <div class="form-group">
                                <label>Border Color</label>
                                <input type="color" class="color-picker" id="propBorderColor" value="${this.rgbToHex(style.borderColor)}">
                            </div>
                        `;
                    }

                    if (field.classList.contains('line')) {
                        lineProps = `
                            <div class="form-group">
                                <label>Line Thickness (px)</label>
                                <input type="number" class="form-control" id="propLineThickness" value="${parseInt(style.height)}" min="1" max="20">
                            </div>
                            <div class="form-group">
                                <label>Line Color</label>
                                <input type="color" class="color-picker" id="propLineColor" value="${this.rgbToHex(style.backgroundColor)}">
                            </div>
                        `;
                    }

                    content.innerHTML = `
                        <div class="form-group">
                            <label>Element Type</label>
                            <input type="text" class="form-control" id="propElementType" 
                                    value="${field.classList.contains('shape') ? 'Shape' :
                                    field.classList.contains('line') ? 'Line' : 
                                    field.classList.contains('label') ? 'Label' : 'Field'}" disabled>
                        </div>
                        
                        ${textProps}
                        ${shapeProps}
                        ${lineProps}
                        
                        <div class="input-group">
                            <div class="input-group-sm">
                                <label>Width (px)</label>
                                <input type="number" class="form-control" id="propWidth" 
                                        value="${parseInt(style.width)}" min="10">
                            </div>
                            <div class="input-group-sm">
                                <label>Height (px)</label>
                                <input type="number" class="form-control" id="propHeight" 
                                        value="${parseInt(style.height)}" min="10">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-group-sm">
                                <label>Left (px)</label>
                                <input type="number" class="form-control" id="propLeft" 
                                        value="${parseInt(style.left)}" min="0">
                            </div>
                            <div class="input-group-sm">
                                <label>Top (px)</label>
                                <input type="number" class="form-control" id="propTop" 
                                        value="${parseInt(style.top)}" min="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-danger" id="deleteField">Delete</button>
                            <button class="btn btn-secondary" id="duplicateField">Duplicate</button>
                        </div>
                    `;

                    this.bindPropertyEvents(field);
                }

                bindPropertyEvents(field) {
                    // Text properties
                    const propText = document.getElementById('propText');
                    if (propText) {
                        propText.addEventListener('input', (e) => {
                            field.textContent = e.target.value;
                            this.updateFieldList();
                            this.saveState();
                        });
                    }

                    const propFontSize = document.getElementById('propFontSize');
                    if (propFontSize) {
                        propFontSize.addEventListener('input', (e) => {
                            field.style.fontSize = e.target.value + 'px';
                            this.saveState();
                        });
                    }

                    const propFontWeight = document.getElementById('propFontWeight');
                    if (propFontWeight) {
                        propFontWeight.addEventListener('change', (e) => {
                            field.style.fontWeight = e.target.value;
                            this.saveState();
                        });
                    }

                    const propTextDecoration = document.getElementById('propTextDecoration');
                    if (propTextDecoration) {
                        propTextDecoration.addEventListener('change', (e) => {
                            field.style.textDecoration = e.target.value;
                            this.saveState();
                        });
                    }

                    const propTextColor = document.getElementById('propTextColor');
                    if (propTextColor) {
                        propTextColor.addEventListener('input', (e) => {
                            field.style.color = e.target.value;
                            this.saveState();
                        });
                    }

                    document.getElementById('alignLeft')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        field.style.textAlign = 'left';
                        document.querySelectorAll('#alignLeft, #alignCenter, #alignRight').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        this.saveState();
                    });

                    document.getElementById('alignCenter')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        field.style.textAlign = 'center';
                        document.querySelectorAll('#alignLeft, #alignCenter, #alignRight').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        this.saveState();
                    });

                    document.getElementById('alignRight')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        field.style.textAlign = 'right';
                        document.querySelectorAll('#alignLeft, #alignCenter, #alignRight').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        this.saveState();
                    });

                    // Shape properties
                    const propBorderWidth = document.getElementById('propBorderWidth');
                    if (propBorderWidth) {
                        propBorderWidth.addEventListener('input', (e) => {
                            field.style.borderWidth = e.target.value + 'px';
                            this.saveState();
                        });
                    }

                    const propBorderColor = document.getElementById('propBorderColor');
                    if (propBorderColor) {
                        propBorderColor.addEventListener('input', (e) => {
                            field.style.borderColor = e.target.value;
                            this.saveState();
                        });
                    }

                    // Line properties
                    const propLineThickness = document.getElementById('propLineThickness');
                    if (propLineThickness) {
                        propLineThickness.addEventListener('input', (e) => {
                            field.style.height = e.target.value + 'px';
                            this.saveState();
                        });
                    }

                    const propLineColor = document.getElementById('propLineColor');
                    if (propLineColor) {
                        propLineColor.addEventListener('input', (e) => {
                            field.style.backgroundColor = e.target.value;
                            this.saveState();
                        });
                    }

                    // Dimensions
                    const propWidth = document.getElementById('propWidth');
                    if (propWidth) {
                        propWidth.addEventListener('input', (e) => {
                            field.style.width = e.target.value + 'px';
                            this.saveState();
                        });
                    }

                    const propHeight = document.getElementById('propHeight');
                    if (propHeight) {
                        propHeight.addEventListener('input', (e) => {
                            field.style.height = e.target.value + 'px';
                            this.saveState();
                        });
                    }

                    // Position
                    const propLeft = document.getElementById('propLeft');
                    if (propLeft) {
                        propLeft.addEventListener('input', (e) => {
                            field.style.left = e.target.value + 'px';
                            this.saveState();
                        });
                    }

                    const propTop = document.getElementById('propTop');
                    if (propTop) {
                        propTop.addEventListener('input', (e) => {
                            field.style.top = e.target.value + 'px';
                            this.saveState();
                        });
                    }

                    // Actions
                    document.getElementById('deleteField').addEventListener('click', () => {
                        this.deleteField(field);
                    });

                    document.getElementById('duplicateField').addEventListener('click', () => {
                        this.duplicateField(field);
                    });
                }

                hideProperties() {
                    const content = document.getElementById('propertiesContent');
                    content.innerHTML = '<div class="no-selection">Select a field to edit its properties</div>';
                }

                deleteField(field) {
                    if (confirm('Are you sure you want to delete this field?')) {
                        field.remove();
                        this.selectedField = null;
                        this.hideProperties();
                        this.updateFieldList();
                        this.saveState();
                    }
                }

                duplicateField(field) {
                    const duplicate = field.cloneNode(true);
                    duplicate.classList.remove('selected');

                    const oldClass = Array.from(field.classList).find(c => c.startsWith('field-'));
                    let baseName = 'duplicate';
                    let nextNum = 1;

                    if (oldClass) {
                        const parts = oldClass.split('-');
                        if (parts.length >= 2) {
                            baseName = parts[1];
                        }
                        nextNum = this.getNextFieldNumber(baseName);
                    }

                    this.fieldCounter = Math.max(this.fieldCounter, nextNum);

                    if (oldClass) {
                        duplicate.classList.remove(oldClass);
                    }
                    duplicate.classList.add(`field-${baseName}-${this.fieldCounter}`);

                    const currentLeft = parseInt(duplicate.style.left);
                    const currentTop = parseInt(duplicate.style.top);
                    duplicate.style.left = (currentLeft) + 'px';
                    duplicate.style.top = (currentTop + 15) + 'px';
                    //duplicate.style.top = (currentTop + 528) + 'px';

                    document.getElementById('formWrapper').appendChild(duplicate);
                    this.setupFieldEvents(duplicate);
                    this.selectField(duplicate);
                    this.updateFieldList();
                    this.saveState();
                }

                getNextFieldNumber(baseName) {
                    const fields = document.querySelectorAll('.field');
                    const existingNumbers = [];

                    fields.forEach(field => {
                        const classes = Array.from(field.classList);
                        classes.forEach(className => {
                            if (className.startsWith(`field-${baseName}-`)) {
                                const num = parseInt(className.split('-').pop());
                                if (!isNaN(num)) existingNumbers.push(num);
                            } else if (className.startsWith(`field-${baseName}`)) {
                                const parts = className.split('-');
                                if (parts.length === 3) {
                                    const num = parseInt(parts[2]);
                                    if (!isNaN(num)) existingNumbers.push(num);
                                }
                            }
                        });
                    });

                    if (existingNumbers.length === 0) return 1;

                    const maxNumber = Math.max(...existingNumbers);
                    return maxNumber + 1;
                }

                updateFieldList() {
                    const fieldList = document.getElementById('fieldList');
                    const fields = document.querySelectorAll('.field');

                    fieldList.innerHTML = '';

                    fields.forEach((field, index) => {
                        const item = document.createElement('div');
                        item.className = 'field-item';
                        item.textContent = field.textContent || `Field ${index + 1}`;

                        if (field === this.selectedField) {
                            item.classList.add('selected');
                        }

                        item.addEventListener('click', () => {
                            this.selectField(field);
                        });

                        fieldList.appendChild(item);
                    });
                }

                handleKeyboard(e) {
                    if (!this.selectedField) return;

                    const moveAmount = e.ctrlKey || e.metaKey ? 10 : 1;

                    switch (e.key) {
                        case 'ArrowUp':
                            e.preventDefault();
                            this.selectedField.style.top = (parseInt(this.selectedField.style.top) - moveAmount) + 'px';
                            this.saveState();
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            this.selectedField.style.top = (parseInt(this.selectedField.style.top) + moveAmount) + 'px';
                            this.saveState();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.selectedField.style.left = (parseInt(this.selectedField.style.left) - moveAmount) + 'px';
                            this.saveState();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            this.selectedField.style.left = (parseInt(this.selectedField.style.left) + moveAmount) + 'px';
                            this.saveState();
                            break;
                        case 'Delete':
                            e.preventDefault();
                            this.deleteField(this.selectedField);
                            break;
                        case 'Escape':
                            this.selectField(null);
                            break;
                    }
                }

                zoom(factor) {
                    this.zoomLevel *= factor;
                    this.zoomLevel = Math.max(0.1, Math.min(5, this.zoomLevel));

                    const formWrapper = document.getElementById('formWrapper');
                    formWrapper.style.transform = `scale(${this.zoomLevel})`;
                    formWrapper.style.transformOrigin = 'top left';

                    document.getElementById('zoomLevel').textContent = Math.round(this.zoomLevel * 100) + '%';
                }

                fitToPage() {
                    const container = document.querySelector('.canvas-container');
                    const wrapper = document.getElementById('formWrapper');

                    const containerWidth = container.clientWidth - 40;
                    const containerHeight = container.clientHeight - 40;

                    const wrapperWidth = wrapper.offsetWidth;
                    const wrapperHeight = wrapper.offsetHeight;

                    const scaleX = containerWidth / wrapperWidth;
                    const scaleY = containerHeight / wrapperHeight;

                    this.zoomLevel = Math.min(scaleX, scaleY);

                    wrapper.style.transform = `scale(${this.zoomLevel})`;
                    wrapper.style.transformOrigin = 'top left';

                    document.getElementById('zoomLevel').textContent = Math.round(this.zoomLevel * 100) + '%';
                }

                updateMousePosition(e) {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const x = Math.round((e.clientX - rect.left) / this.zoomLevel);
                    const y = Math.round((e.clientY - rect.top) / this.zoomLevel);

                    this.updatePositionInfo(x, y);
                }

                updatePositionInfo(x, y) {
                    document.getElementById('positionInfo').textContent = `Position: ${x}, ${y}`;
                }

                updateStatus(message) {
                    document.getElementById('statusText').textContent = message;
                    setTimeout(() => {
                        document.getElementById('statusText').textContent = 'Ready';
                    }, 3000);
                }

                saveState() {
                    const state = {
                        fields: [],
                        canvasSize: {
                            width: document.getElementById('canvasWidth').value,
                            height: document.getElementById('canvasHeight').value
                        }
                    };

                    document.querySelectorAll('.field').forEach(field => {
                        const fieldData = {
                            text: field.textContent,
                            className: Array.from(field.classList).find(c => c.startsWith('field-')),
                            style: {
                                left: field.style.left,
                                top: field.style.top,
                                width: field.style.width,
                                height: field.style.height,
                                fontSize: field.style.fontSize,
                                fontFamily: field.style.fontFamily,
                                fontWeight: field.style.fontWeight,
                                textDecoration: field.style.textDecoration,
                                color: field.style.color,
                                backgroundColor: field.style.backgroundColor,
                                borderWidth: field.style.borderWidth,
                                borderStyle: field.style.borderStyle,
                                borderColor: field.style.borderColor,
                                transform: field.style.transform
                            }
                        };
                        state.fields.push(fieldData);
                    });

                    this.history = this.history.slice(0, this.historyIndex + 1);
                    this.history.push(JSON.stringify(state));
                    this.historyIndex++;

                    if (this.history.length > 50) {
                        this.history.shift();
                        this.historyIndex--;
                    }
                }

                undo() {
                    if (this.historyIndex > 0) {
                        this.historyIndex--;
                        this.restoreState(JSON.parse(this.history[this.historyIndex]));
                        this.updateStatus('Undo');
                    }
                }

                redo() {
                    if (this.historyIndex < this.history.length - 1) {
                        this.historyIndex++;
                        this.restoreState(JSON.parse(this.history[this.historyIndex]));
                        this.updateStatus('Redo');
                    }
                }

                restoreState(state) {
                    document.querySelectorAll('.field').forEach(field => field.remove());

                    document.getElementById('canvasWidth').value = state.canvasSize.width;
                    document.getElementById('canvasHeight').value = state.canvasSize.height;
                    this.updateCanvasSize();

                    state.fields.forEach(fieldData => {
                        const field = document.createElement('div');
                        field.className = 'field draggable ' + fieldData.className;
                        field.textContent = fieldData.text;
                        field.contentEditable = true;

                        Object.assign(field.style, fieldData.style);

                        if (fieldData.className.includes('rectangle')) {
                            this.addResizeHandles(field);
                        }

                        if (fieldData.className.includes('line')) {
                            const startPoint = document.createElement('div');
                            startPoint.className = 'line-endpoint start-point';
                            startPoint.style.display = 'none';

                            const endPoint = document.createElement('div');
                            endPoint.className = 'line-endpoint end-point';
                            endPoint.style.display = 'none';

                            const rotateHandle = document.createElement('div');
                            rotateHandle.className = 'rotate-handle';
                            rotateHandle.style.display = 'none';

                            field.appendChild(startPoint);
                            field.appendChild(endPoint);
                            field.appendChild(rotateHandle);
                        }

                        document.getElementById('formWrapper').appendChild(field);
                        this.setupFieldEvents(field);
                    });

                    this.selectedField = null;
                    this.hideProperties();
                    this.updateFieldList();
                }

                rgbToHex(rgb) {
                    if (rgb.startsWith('#')) return rgb;

                    const match = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)$/);
                    if (!match) return '#000000';

                    const r = parseInt(match[1]);
                    const g = parseInt(match[2]);
                    const b = parseInt(match[3]);

                    return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
                }

                selectTextContent(element) {
                    const range = document.createRange();
                    range.selectNodeContents(element);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }

                downloadHtml() {
                    const formWrapper = document.getElementById('formWrapper').cloneNode(true);

                    // Remove editor-specific elements
                    formWrapper.querySelectorAll('.rulers, .guideline').forEach(el => el.remove());
                    formWrapper.querySelectorAll('.resize-handle, .line-endpoint, .rotate-handle').forEach(el => {
                        el.style.display = 'none';
                    });

                    formWrapper.classList.remove('grid-bg');

                    // Clean up field classes and styles
                    formWrapper.querySelectorAll('.field').forEach(field => {
                        field.classList.remove('selected', 'dragging');
                        field.contentEditable = false;
                        field.style.border = field.style.borderStyle === 'none' ? 'none' : field.style.border;
                    });

                    const cssLines = [];
                    document.querySelectorAll('.field').forEach(field => {
                        const className = Array.from(field.classList).find(c => c.startsWith('field-'));
                        if (className) {
                            const style = getComputedStyle(field);
                            cssLines.push(`
                                .${className} {
                                    position: absolute;
                                    top: ${field.style.top};
                                    left: ${field.style.left};
                                    width: ${field.style.width || 'auto'};
                                    height: ${field.style.height || 'auto'};
                                    text-align: ${field.style.textAlign || 'left'};
                                    font-size: ${field.style.fontSize || style.fontSize};
                                    font-family: ${field.style.fontFamily || style.fontFamily};
                                    font-weight: ${field.style.fontWeight || style.fontWeight};
                                    text-decoration: ${field.style.textDecoration || style.textDecoration};
                                    color: ${field.style.color || style.color};
                                    background-color: ${field.style.backgroundColor || 'transparent'};
                                    transform: ${field.style.transform || 'none'};
                                }`);
                        }
                    });

                    const canvasWidth = document.getElementById('canvasWidth').value;
                    const canvasHeight = document.getElementById('canvasHeight').value;

                    const htmlContent = `<!DOCTYPE html>
                        <html lang="en">
                            <head>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>Generated Template</title>
                                <style>
                                    body {
                                        margin: 0;
                                        padding: 0;
                                        font-family: Arial, sans-serif;
                                    }

                                    .form-wrapper {
                                        position: relative;
                                        width: ${canvasWidth}in;
                                        height: ${canvasHeight}in;
                                        border: 1px solid #000;
                                        margin: 0 auto;
                                        background: white;
                                    }

                                    .field {
                                        position: absolute;
                                        font-weight: normal;
                                        padding: 0px;
                                        font-size: 10px;
                                    }

                                    ${cssLines.join('\n')}

                                    @media print {
                                        @page {
                                            size: ${canvasWidth}in ${canvasHeight}in;
                                            margin: 0;
                                        }

                                        body {
                                            margin: 0;
                                            padding: 0;
                                        }

                                        .form-wrapper {
                                            border: none;
                                            margin: 0;
                                        }
                                    }
                                </style>

                            </head>
                            <body>
                                ${formWrapper.outerHTML}
                            </body>
                        </html>`;

                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'template.html';
                    a.click();
                    URL.revokeObjectURL(url);

                    this.updateStatus('HTML template downloaded');
                }

                downloadPdf() {
                    const originalWrapper = document.getElementById('formWrapper');
                    const formWrapper = originalWrapper.cloneNode(true);

                    // Preserve 'hide-labels' class
                    if (originalWrapper.classList.contains('hide-labels')) {
                        formWrapper.classList.add('hide-labels');
                    }

                    // Remove editor-specific elements
                    formWrapper.querySelectorAll('.rulers, .guideline').forEach(el => el.remove());
                    formWrapper.querySelectorAll('.resize-handle, .line-endpoint, .rotate-handle').forEach(el => {
                        el.style.display = 'none';
                    });

                    formWrapper.classList.remove('grid-bg');

                    // Clean up field classes and styles
                    formWrapper.querySelectorAll('.field').forEach(field => {
                        field.classList.remove('selected', 'dragging');
                        field.contentEditable = false;
                        field.style.border = field.style.borderStyle === 'none' ? 'none' : field.style.border;
                    });

                    const canvasWidth = document.getElementById('canvasWidth').value;
                    const canvasHeight = document.getElementById('canvasHeight').value;

                    const htmlContent = `<!DOCTYPE html>
                        <html lang="en">
                            <head>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>PDF Export</title>
                                <style>
                                    body {
                                        margin: 0;
                                        padding: 0;
                                        font-family: Arial, sans-serif;
                                    }

                                    .form-wrapper {
                                        position: relative;
                                        width: ${canvasWidth}in;
                                        height: ${canvasHeight}in;
                                        margin: 0;
                                        background: white;
                                    }

                                    .field {
                                        position: absolute;
                                        font-weight: normal;
                                        padding: 0px;
                                        font-size: 10px;
                                    }

                                    .hide-labels .label {
                                        display: none !important;
                                    }

                                    @media print {
                                        @page {
                                            size: ${canvasWidth}in ${canvasHeight}in;
                                            margin: 0;
                                        }

                                        body {
                                            margin: 0;
                                            padding: 0;
                                        }

                                        .form-wrapper {
                                            border: none;
                                            margin: 0;
                                        }
                                    }
                                </style>
                            </head>
                            <body>
                                ${formWrapper.outerHTML}
                            </body>
                        </html>`;

                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(htmlContent);
                    printWindow.document.close();

                    printWindow.onload = function () {
                        printWindow.focus();
                        //printWindow.print();
                        //printWindow.close();
                    };

                    this.updateStatus('PDF download initiated');
                }


                loadHtmlTemplate(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    if (!confirm("This will override the current layout. Continue?")) {
                        event.target.value = "";
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(e.target.result, 'text/html');
                        const importedWrapper = doc.querySelector('.form-wrapper');

                        if (!importedWrapper) {
                            alert("Invalid template. No .form-wrapper found.");
                            return;
                        }

                        const container = document.querySelector('.canvas-container');
                        const oldWrapper = document.getElementById('formWrapper');
                        if (oldWrapper) oldWrapper.remove();

                        importedWrapper.id = 'formWrapper';
                        container.insertBefore(importedWrapper, container.querySelector('.zoom-controls'));

                        // Reinitialize field events and add editor-specific styles
                        importedWrapper.querySelectorAll('.field').forEach(field => {
                            this.setupFieldEvents(field);
                            field.style.padding = '0px 1px';

                            if (field.classList.contains('rectangle')) {
                                this.addResizeHandles(field);
                            }

                            if (field.classList.contains('line')) {
                                const startPoint = document.createElement('div');
                                startPoint.className = 'line-endpoint start-point';
                                startPoint.style.display = 'none';

                                const endPoint = document.createElement('div');
                                endPoint.className = 'line-endpoint end-point';
                                endPoint.style.display = 'none';

                                const rotateHandle = document.createElement('div');
                                rotateHandle.className = 'rotate-handle';
                                rotateHandle.style.display = 'none';

                                field.appendChild(startPoint);
                                field.appendChild(endPoint);
                                field.appendChild(rotateHandle);
                            }
                        });

                        // Update canvas size
                        const style = window.getComputedStyle(importedWrapper);
                        const widthInInches = parseFloat(style.width) / 96;
                        const heightInInches = parseFloat(style.height) / 96;

                        document.getElementById('canvasWidth').value = widthInInches.toFixed(2);
                        document.getElementById('canvasHeight').value = heightInInches.toFixed(2);
                        this.updateCanvasSize();

                        this.selectField(null);
                        this.updateFieldList();
                        this.saveState();
                        this.updateStatus("Template imported successfully");
                    };

                    reader.readAsText(file);
                }
            }

            // Initialize the designer
            const designer = new TemplateDesigner();
        });
    </script>
</body>
</html>